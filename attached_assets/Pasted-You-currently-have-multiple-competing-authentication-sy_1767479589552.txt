You currently have multiple competing authentication systems in the same codebase:

server/auth.ts â†’ session-based auth

server/replitAuth.ts â†’ Replit OIDC / Passport-based auth

server/middleware/security.ts â†’ CSRF + origin logic

Frontend + routes expecting one single source of truth, but backend has two

This causes:

sessions being set in one place

overwritten or ignored in another

/api/auth/user returning 401 even after login

inconsistent behavior between guest and logged-in users

This is not a Supabase issue and not a cookie issue anymore.
Itâ€™s auth duplication.

ğŸ¯ The rule going forward (non-negotiable)

You must have ONE auth system. Not two.

Since you already chose Option 1 (local session auth), we will fully remove Replit OIDC auth.

ğŸ§¹ STEP 1 â€” Disable Replit OIDC completely (5 minutes)
Do this manually in Replit UI:

Delete this file:

server/replitAuth.ts


Open any file that imports it (likely routes.ts or index.ts)
and remove:

import { setupReplitAuth } from "./replitAuth";


or similar

Remove any call like:

setupReplitAuth(app);


ğŸ‘‰ After this, Replit OIDC is gone.

ğŸ§¹ STEP 2 â€” Simplify security middleware

Open:

server/middleware/security.ts


Do NOT delete the file, but:

Remove any auth checks from it

Keep it only for:

headers

CSP

rate limiting (if any)

âŒ No session checks
âŒ No CSRF auth enforcement
âŒ No origin blocking for login

Auth must live only in auth.ts.

ğŸ” STEP 3 â€” Keep ONLY this auth flow

Your only auth file should now be:

server/auth.ts


It should define:

getSession()

/api/auth/register

/api/auth/login

/api/auth/logout

/api/auth/user

isAuthenticated

No Passport
No OIDC
No second auth middleware

ğŸ§© STEP 4 â€” Confirm server wiring (important)

Open:

server/index.ts


It must be in this order:

app.set("trust proxy", 1);
app.use(getSession());           // FIRST
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

registerRoutes(app);             // auth routes included here


âŒ No replitAuth
âŒ No duplicate session setup

ğŸŒ STEP 5 â€” Frontend (very important)

Every authenticated request must include:

credentials: "include"


Specifically check:

/api/auth/user

/api/auth/stats

/api/auth/logout

If even one is missing â†’ login appears broken.