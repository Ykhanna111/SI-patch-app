âŒ What is happening (exact cause)

This line is crashing your app:

req.session.csrfToken


because req.session is undefined.

From your logs:

TypeError: Cannot read properties of undefined (reading 'csrfToken')
CSRF: Token mismatch or missing - provided: false, session: false


This proves two things:

CSRF logic is running

Session does NOT exist yet

So your CSRF system is executing before a session is created.

That is the root cause.

â— Why this breaks EVERYTHING
Guest mode

Guest has no session

CSRF runs anyway

req.session is undefined

âŒ crash / 403

Login

Login happens before session exists

CSRF blocks login

Session never gets created

âŒ cannot log in

So CSRF is blocking the very thing that creates the session.

âœ… The ONLY correct rule for CSRF

CSRF protection must ONLY run when a session already exists.

Anything else is incorrect.

ğŸ› ï¸ EXACT FIX (DO THIS)
ğŸ”§ 1ï¸âƒ£ Fix generateCsrfToken (this is mandatory)

Replace your CSRF token generator with this safe version:

function generateCsrfToken(req, res) {
  // âœ… If no session exists, do NOT try to access it
  if (!req.session) {
    return res.status(401).json({ message: "No active session" });
  }

  if (!req.session.csrfToken) {
    req.session.csrfToken = crypto.randomBytes(32).toString("hex");
  }

  res.json({ csrfToken: req.session.csrfToken });
}


âŒ Never assume req.session exists
âŒ Never read req.session.csrfToken without checking

ğŸ”§ 2ï¸âƒ£ Fix CSRF validation middleware (critical)

Update your CSRF middleware to skip validation if session doesnâ€™t exist:

function csrfProtection(req, res, next) {
  // âœ… Allow requests without a session (guest, login, etc.)
  if (!req.session) {
    return next();
  }

  const token =
    req.headers["x-csrf-token"] || req.body?._csrf;

  if (!token || token !== req.session.csrfToken) {
    return res.status(403).json({
      message: "Your session has expired or is invalid",
    });
  }

  next();
}

ğŸ”§ 3ï¸âƒ£ DO NOT apply CSRF globally

âŒ WRONG:

app.use(csrfProtection);


âœ… CORRECT:

// Only protect authenticated, state-changing routes
app.post("/api/auth/profile", csrfProtection, ...);
app.post("/api/games/save", csrfProtection, ...);

ğŸ”§ 4ï¸âƒ£ CSRF must NOT run on these routes

Remove CSRF from:

/api/login

/api/register

/api/games (guest play)

/api/csrf-token

CSRF is meaningless for guests.