The exact root cause (final, no guessing)

Your /api/auth/login route is NOT completing â€” it is exiting early before the session is set.

That is why:

req.session.userId is never set

/api/auth/user is always 401

Login appears to do something, but nothing actually happens server-side

This is not cookies, not Supabase, not CSRF anymore.

WHY the login route exits early (the real reason)

From the auth.ts code you shared earlier, there are three early-exit guards in /api/auth/login:

1ï¸âƒ£ validateOrigin(req) âŒ (MOST COMMON CULPRIT)
if (!validateOrigin(req)) {
  return res.status(403).json({ message: "Forbidden: Invalid origin" });
}


In production (Render):

Origin header is often missing or different

Reverse proxy changes host/origin

This function returns false

Login route exits immediately

Your log is never printed

ğŸ‘‰ This is exactly why login never completes.

2ï¸âƒ£ loginSchema.safeParse(req.body) âŒ

If frontend sends:

wrong field names

empty body

wrong Content-Type

Then validation fails and login exits.

3ï¸âƒ£ storage.getUserByUsername() returns null

If the user does not exist, login exits.

BUT we know which one it is

Because:

You said no log prints

You see no server crash

You didnâ€™t mention a 400/401 error message in frontend

This exact issue is extremely common on Render

â¡ï¸ validateOrigin(req) is blocking login.

âœ… THE FIX (DO THIS NOW â€” SIMPLE & FINAL)
ğŸ”§ Fix #1 â€” Disable origin validation for login (recommended)

In auth.ts, change this:

âŒ Current

if (!validateOrigin(req)) {
  return res.status(403).json({ message: "Forbidden: Invalid origin" });
}


âœ… Replace with

// â— Disable origin validation for login
// Origin validation breaks behind proxies


ğŸ‘‰ Remove this check entirely from /api/auth/login and /api/auth/register.

You already have:

CSRF protection

Session cookies

Same-origin deployment

This check is doing more harm than good.

ğŸ”§ Fix #2 â€” Ensure login actually sets session

Your login route must contain this (unchanged):

req.session.userId = user.id;
console.log("LOGIN OK, session.userId =", req.session.userId);


After removing validateOrigin, this log WILL print.

Why this worked locally but not on Render

Locally:

Origin and Host match

validateOrigin() returns true

On Render:

Requests come through a reverse proxy

Origin may be missing or rewritten

Your validation rejects legitimate requests

This is a classic production-only bug.

One-line final truth (memorize this)

Login never worked because your validateOrigin() check was rejecting all production login requests before the session could be set.

Thatâ€™s it. Nothing else.